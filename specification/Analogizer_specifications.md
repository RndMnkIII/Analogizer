# Analogizer Specifications

## Basics
 The basis of the Analogizer adapter is to expand the possibilities of the Analogue Pocket portable console in two fundamental aspects. On the one hand
 allow obtaining an analog video output from the video signals generated by the core before being adapted to the characteristics
 Pocket display. This means using the resolution, refresh rates, sync signals, etc. of the original core as it was.
 implemented to replicate the original system. No preprocessing of any kind is applied beyond adapting certain signals to be able to generate the
 different video outputs (RGBS,RGsB,YPbPr, Y/C,RGBHV). This video signal will be compatible with different types of screens, the main objective
 CRT displays with an operating frequency of 15KHz and with different types of video input: SCART RGB, SCART SVideo, SCART Composite, video
 component with YPbPr, SVideo, composite video. Additionally, using a scandoubler module, there will be the possibility of viewing the video using
 SVGA monitors. On the other hand, we want to add the possibility of using native game controllers with the Pocket cores. This is achieved using
 the already established base of official SNAC adapters for MiSTEr that use the SNAC7 protocol and USB 3 type A connector. Analogizer today
 offers SNAC support for 1/2 players for NeoGeo DB15, NES, SNES type controllers. Additionally, it offers 1-player support for PCEngine controllers.
 2 and 6 buttons. This support expands to 4 players using NEC's 5-player multitap adapter. For PCEngine type controls and NEC multitap
 It is necessary to use a wiring harness between the SNAC adapter and the Analogizer due to certain limitations of the Analogizer adapter (it does not have freedom
 to configure SNAC signals as input or output on an individual level and certain signals have a fixed output or input configuration) due to how
 The Pocket's cartridge expansion port works. The adapter has a side switch marked A/B, the default position being A. This
 affects the layout of signals for the SNAC port. Configuration A supports the types of controls listed above. B is reserved for
 future expansions, for example to support PSX controllers. All of this functionality consumes logic resources directly from the Pocket's Cyclone V FPGA.
 that must be shared with the implementation of the core in question to which you want to add support.

## Video output signals
 The main use of Analogizer is that it allows you to obtain different types of analog video signals. It is essential to implement all of them, especially
 the Y/C output for SVideo and composite video, taking into account that most of the CRT TV devices available to users only have this
 video inputs, followed by users with TVs with component video inputs and TVs with SCART inputs. SVGA output is considered accessory for users
 They do not have CRT TV screens but they do have SVGA video monitors.
 In order of video output quality on CRT, the following are recommended:
 * SCART RGB
 * YPbpr component video (requires R2 version of Analogizer with SOG)
 * Y/C SVideo
 * Y/C composite video
 * SVGA

## SNAC adapters for controllers
 The second most important functionality that Analogizer offers is that it allows you to use SNAC7 adapters with a USB 3 (type A) connector that already exist in Analogizer with certain limitations.
 This means that you can currently use native controllers for Neogeo DB15, NES, SNES and PCEngine 2btn and 6btn connectors and the NEC 5-player MultiTap adapter (currently 
 you are limited to 4 players by the Analogizer interface). That said, there are countless designs that in most cases will work without problems. In the README of the main Analogizer repository, the different types of adapters compatible with Analogizer will be added, there are versions for both 1 controller and 2 controllers (DB15, NES, SNES). For controls of the type
 PCEngine is also required to have a wiring harness specifically created for Analogizer (it is available for sale in the Analogizer online store and the pcb design is public for users interested in building it themselves). At one end it is connected to the SNAC adapter through a USB 3 female type A connector and at the other end it is
 connects Analogizer with a USB 3 male type A connector. USB 3 female-male extension cables can be used at the convenience of users and is the recommended connection method to avoid
 Excessive stress on the connectors if all these adapters are connected together directly.

 It must be taken into account that the Blue212 type SNAC adapters use two boards (one of them is specific to the native control and has the native connector but does not have its own circuitry). The other board is a common design for all controls and is connected directly to the previous one, it provides all the electronics to convert voltage levels between the controls signals.
 and Analogizer.

## Analogizer interface (development)
The first modification that must be added to the original core code is to enable the Pocket's cartridge port. To do this we must edit the `core.json` file located in the same location as the core bitstream and set `"cartridge_adapter"` to the value`0`:

```
{
  "core": {
    "magic": "APF_VER_1",
    ...
        "framework": {
      "target_product": "Analogue Pocket",
      ...
         "hardware": {
           "link_port": false,
           "cartridge_adapter": 0
         },
```

As the creator of Analogizer I have also developed an interface in Verilog that encapsulates all the functionality in a single module that must be instantiated.
This module is the one that connects the different parts involved so that everything works correctly.

This module communicates with the adapter directly through the Pocket's cartridge expansion port. This port is available in the framework
of Analogue openFPGA for the developer, using the following signals instantiated in the highest level module as follows:

```
module apf_top \(
...
        ///////////////////////////////////////////////////
        // cartridge interface
        // switches between 3.3v and 5v mechanically
        // output enable for multibit translators controlled by PIC32

        // GBA AD[15:8]
        inout   wire    [7:0]   cart_tran_bank2,
        output  wire            cart_tran_bank2_dir,

        // GBA AD[7:0]
        inout   wire    [7:0]   cart_tran_bank3,
        output  wire            cart_tran_bank3_dir,

        // GBA A[23:16]
        inout   wire    [7:0]   cart_tran_bank1,
        output  wire            cart_tran_bank1_dir,

        // GBA [7] PHI#
        // GBA [6] WR#
        // GBA [5] RD#
        // GBA [4] CS1#/CS#
        //     [3:0] unwired
        inout   wire    [7:4]   cart_tran_bank0,
        output  wire            cart_tran_bank0_dir,

        // GBA CS2#/RES#
        inout   wire            cart_tran_pin30,
        output  wire            cart_tran_pin30_dir,
        // when GBC cart is inserted, this signal when low or weak will pull GBC /RES low with a special circuit
        // the goal is that when unconfigured, the FPGA weak pullups won't interfere.
        // thus, if GBC cart is inserted, FPGA must drive this high in order to let the level translators
        // and general IO drive this pin.
        output  wire            cart_pin30_pwroff_reset,

        // GBA IRQ/DRQ
        inout   wire            cart_tran_pin31,
        output  wire            cart_tran_pin31_dir,
		...
  \)
``` 


Normally the `openFPGA_Pocket_Analogizer` module is instantiated at a lower level, where the core module is instantiated.
The only thing that is required is to connect the required signals between the core of the machine that is going to be executed and the instance of the module.
Analogizer:

| SIGNAL                 | TYPE     | WIDTH | FUNCTION                                                                                                       |
| :--------------------: | :------: | :---: | :------------------------------------------------------------------------------------------------------------: |
| MASTER_CLK_FREQ        | PARAMETER|       | This parameter is used to calculate the delay in timing signals for SNAC                                       |
| i_clk                  | INPUT    | 1     | main clock. It can be the core master clock or the video clock.                                                |
| i_rst                  | INPUT    | 1     | reset signal active at high. Resets the interface and keeps the cartridge port in the default state            |
| i_ena                  | INPUT    | 1     | enable signal. If disabled, it keeps the cartridge port in the default state                                   |
| analog_video_type      | INPUT    | 4     | Select Analogizer video output through the video output port                                                   |
| R                      | INPUT    | 8     | color channel R. Internally it is reduced to the 6 bits with the highest weight                                |
| G                      | INPUT    | 8     | color channel G. Internally it is reduced to the 6 bits with the highest weight                                |
| B                      | INPUT    | 8     | color channel B. Internally it is reduced to the 6 bits with the highest weight                                |
| HBlank                 | INPUT    | 1     | horizontal blanking signal                                                                                     |
| VBlank                 | INPUT    | 1     | vertical blanking signal                                                                                       |
| BLANKn                 | INPUT    | 1     | active low composite blanking signal \(ADV7123 requires it for RGBS, RGsB video output\)                         |
| Hsync                  | INPUT    | 1     | horizontal synchronization signal                                                                              |
| Vsync                  | INPUT    | 1     | vertical synchronization signal                                                                                |
| Csync                  | INPUT    | 1     | composite synchronization signal. The generation of this signal is specific to each core                       |
| video_clk              | INPUT    | 1     | video clock for the ADV7123. Depending on the core, this signal may be the same as i_clk or another specific   |
| PALFLAG                | INPUT    | 1     | Y/C specific signal. Allows you to adapt SVideo and composite video to PAL\(=1\) or NTSC\(=0\)                     |
| MUFLAG                 | INPUT    | 1     | specific Y/C signal \(DEBUG\). Modifies the way the phase accumulator is calculated (default =0)                 |
| CHROMA_ADD             | INPUT    | 5     | specific Y/C signal \(DEBUG\). Allows you to adjust the value of the phase accumulator in the development phase  |
| CHROMA_MULT            | INPUT    | 5     | specific Y/C signal \(DEBUG\). Allows you to adjust the value of the phase accumulator in the development phase  |
| CHROMA_PHASE_INC       | INPUT    | 40    | Y/C specific signal. Tuned phase accumulator step value for core frequency                                     |
| COLORBURST_RANGE       | INPUT    | 27    | Y/C specific signal. Tuned color burst value for core video frequency                                          |
| ce_divider             | INPUT    | 3     | Scandoubler RGBHV specifies signal. Pixel clock divider. Use value that best fits the image                    |
| conf_AB                | INPUT    | 1     | SNAC signal. Configuration A\(=0\) or B\(=1\) for SNAC. It must match the position of the A/B switch               |
| game_cont_type         | INPUT    | 5     | SNAC signal. Specifies if SNAC commands are not used and if what type are used (See interact.json file)        |
| p1_btn_state           | OUTPUT   | 16    | SNAC signal. Status of SNAC control buttons for player1 \(ST,SEL,R3,L3,R2,L2,R1,L1,Y,X,B,A,R,L,D,U\)             |
| p2_btn_state           | OUTPUT   | 16    | SNAC signal. Status of SNAC control buttons for player2 \(ST,SEL,R3,L3,R2,L2,R1,L1,Y,X,B,A,R,L,D,U\)             |
| p3_btn_state           | OUTPUT   | 16    | SNAC signal. Status of SNAC control buttons for player3 \(ST,SEL,R3,L3,R2,L2,R1,L1,Y,X,B,A,R,L,D,U\)             |
| p4_btn_state           | OUTPUT   | 16    | SNAC signal. Status of SNAC control buttons for player4 \(ST,SEL,R3,L3,R2,L2,R1,L1,Y,X,B,A,R,L,D,U\)             |
| cart_tran_bank2        | I/O      | 8     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank2_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank3        | I/O      | 8     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank3_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank1        | I/O      | 8     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank1_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank0        | I/O      | 4     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_bank0_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_pin30        | I/O      | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_pin30_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_pin30_pwroff_reset| OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_pin31        | I/O      | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| cart_tran_pin31_dir    | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |
| o_stb                  | OUTPUT   | 1     | Interface with the cartridge port. Connects directly to the signals of the higher level module                 |


So that the user can modify the Analogizer options, three groups of options are established. These options are usually set in the `interact.js` file which is in the same location as the core bitstream. This may change in the case of cores that have different options depending on the game you want to load:

```
{
  "interact": {
    "magic": "APF_VER_1",
    "variables": [
       {
        "name": "SNAC Adapter",
        "id": 43,
        "type": "list",
        "enabled": true,
        "persist": true,
        "address": "0xA0000000",
        "defaultval": "0x00",
        "mask": "0xFFFFFFE0",
        "options": [
            {
            "value": "0x00",
            "name": "None"
            },
            {
            "value": "0x01",
            "name": "DB15 Normal"
            },
            {
            "value": "0x02",
            "name": "NES"
            },
            {
            "value": "0x03",
            "name": "SNES"
            },
            {
            "value": "0x04",
            "name": "PCE 2BTN"
            },
            {
            "value": "0x05",
            "name": "PCE 6BTN"
            },
            {
            "value": "0x06",
            "name": "PCE Multitap"
            },
            {
              "value": "0x09",
              "name": "DB15 Fast"
            },
            {
              "value": "0x0B",
              "name": "SNES A,B<->X,Y"
            }
        ]
    },
    {
        "name": "SNAC Controller Assignment",
        "id": 44,
        "type": "list",
        "enabled": true,
        "persist": true,
        "address": "0xA0000000",
        "defaultval": "0x00",
        "mask": "0xFFFFFC3F",
        "options": [
            {
              "value": "0x0",
              "name": "SNAC -> P1"
            },
            {
              "value": "0x40",
              "name": "SNAC -> P2"
            },
            {
              "value": "0x80",
              "name": "SNAC P1,P2->P1,P2"
            },
            {
              "value": "0xC0",
              "name": "SNAC P1,P2->P2,P1"
            },
            {
              "value": "0x200",
              "name": "SNAC P1,P2->P3,P4"
            },
            {
              "value": "0x100",
              "name": "SNAC P1-P4->P1-P4"
            },
            {
              "value": "0x140",
              "name": "SNAC P1-P2->P1-P2"
            },
            {
              "value": "0x180",
              "name": "SNAC P1-P2->P3-P4"
            }
        ]
    },
    {
        "name": "Analogizer Video Out",
        "id": 45,
        "type": "list",
        "enabled": true,
        "persist": true,
        "address": "0xA0000000",
        "defaultval": "0x0",
        "mask": "0xFFFFC3FF",
        "options": [
            {
              "value": "0x0",
              "name": "RGBS"
            },
            {
              "value": "0x0400",
              "name": "RGsB"
            },
            {
              "value": "0x0800",
              "name": "YPbPr"
            },
            {
              "value": "0x0C00",
              "name": "Y/C NTSC"
            },
            {
              "value": "0x1400",
              "name": "Scandoubler RGBHV"
            },
            {
              "value": "0x2000",
              "name": "RGBS,Pocket OFF"
            },
            {
              "value": "0x2400",
              "name": "RGsB,Pocket OFF"
            },
            {
              "value": "0x2800",
              "name": "YPbPr,Pocket OFF"
            },            {
              "value": "0x2C00",
              "name": "Y/C NTSC,Pocket OFF"
            },
            {
              "value": "0x3400",
              "name": "Scandoubler,Pocket OFF"
            }
        ]
    },
    ...
        ],
    "messages": []
  }
}
```

In a schematic way, these would be the different options that can be selected for Analogizer:

```
  SNAC Adapter
    |                            FUNCTION                    VALUE (hex) WIDTH ADDRESS    MASK       MASKED VALUE
    +----------- None            disables SNAC interface     0x0         5     0xA0000000 0xFFFFFFE0 0x00        
    +----------- DB15 Normal     1/2 players                 0x1         5     0xA0000000 0xFFFFFFE0 0x01        
    +----------- NES             1/2 players                 0x2         5     0xA0000000 0xFFFFFFE0 0x02        
    +----------- SNES            1/2 players                 0x3         5     0xA0000000 0xFFFFFFE0 0x03         
    +----------- PCE 2BTN        1 player                    0x4         5     0xA0000000 0xFFFFFFE0 0x04         
    +----------- PCE 6BTN        1 player                    0x5         5     0xA0000000 0xFFFFFFE0 0x05         
    +----------- PCE Multitap    allows 4 players            0x6         5     0xA0000000 0xFFFFFFE0 0x06         
    +----------- DB15 Fast       uses faster sampling        0x9         5     0xA0000000 0xFFFFFFE0 0x09         
    +----------- SNES A,B<->X,Y  swap A,B X,Y buttons        0xB         5     0xA0000000 0xFFFFFFE0 0x0B         
``` 

```
  SNAC Controller Assignment 
    |                              FUNCTION                                       VALUE (hex) WIDTH ADDRESS    MASK       MASKED VALUE
    +----------- SNAC -> P1        SNAC controller to P1                          0x0         4     0xA0000000 0xFFFFFC3F 0x000                 
    +----------- SNAC -> P2        SNAC controller to P2                          0x1         4     0xA0000000 0xFFFFFC3F 0x040           
    +----------- SNAC P1,P2->P1,P2 SNAC cont1,cont2 to P1,P2                      0x2         4     0xA0000000 0xFFFFFC3F 0x080           
    +----------- SNAC P1,P2->P2,P1 SNAC cont1,cont2 to P2,P1                      0x3         4     0xA0000000 0xFFFFFC3F 0x0C0           
    +----------- SNAC P1,P2->P3,P4 SNAC cont1,cont2 to P3,P4 (only for 4P cores)  0x8         4     0xA0000000 0xFFFFFC3F 0x200           
    +----------- SNAC P1-P4->P1-P4 SNAC cont1-cont4 to P1-P4 (only for 4P cores)  0x9         4     0xA0000000 0xFFFFFC3F 0x100           
    +----------- SNAC P1-P2->P1-P2 SNAC cont1-cont2 to P1-P2 (only for 4P cores)  0xA         4     0xA0000000 0xFFFFFC3F 0x140           
    +----------- SNAC P1-P2->P3-P4 SNAC cont1-cont2 to P3-P4 (only for 4P cores)  0xB         4     0xA0000000 0xFFFFFC3F 0x180                     
```

```
  Analogizer Video Out
    |                                   FUNCTION                    VALUE (hex) WIDTH ADDRESS    MASK       MASKED VALUE 
    +----------- RGBS                   idem                        0x0         4     0xA0000000 0xFFFFC3FF 0x0000       
    +----------- RGsB                   idem                        0x1         4     0xA0000000 0xFFFFC3FF 0x0400       
    +----------- YPbPr                  idem                        0x2         4     0xA0000000 0xFFFFC3FF 0x0800       
    +----------- Y/C NTSC               idem                        0x3         4     0xA0000000 0xFFFFC3FF 0x0C00       
    +----------- Y/C PAL                idem                        0x4         4     0xA0000000 0xFFFFC3FF 0x1000       
    +----------- Scandoubler RGBHV      idem                        0x5         4     0xA0000000 0xFFFFC3FF 0x1400       
    +----------- RGBS,Pocket OFF        idem, blanks Pocket screen  0x8         4     0xA0000000 0xFFFFC3FF 0x2000       
    +----------- RGsB,Pocket OFF        idem, blanks Pocket screen  0x9         4     0xA0000000 0xFFFFC3FF 0x2400       
    +----------- YPbPr,Pocket OFF       idem, blanks Pocket screen  0xA         4     0xA0000000 0xFFFFC3FF 0x2800       
    +----------- Y/C NTSC,Pocket OFF    idem, blanks Pocket screen  0xB         4     0xA0000000 0xFFFFC3FF 0x2C00       
    +----------- Y/C PAL,Pocket OFF     idem, blanks Pocket screen  0xC         4     0xA0000000 0xFFFFC3FF 0x3000       
    +----------- Scandoubler,Pocket OFF idem, blanks Pocket screen  0xD         4     0xA0000000 0xFFFFC3FF 0x3400         
```



A range of bridge addresses must be selected in the Pocket framework. In the example, address 0xA0000000 has been reserved for Analogizer.
The interaction in the code is up to the developer, in this example it would look like this:

```
  // for bridge write data, we just broadcast it to all bus devices
  // for bridge read data, we have to mux it
  // add your own devices here
  always @(*) begin
    casex (bridge_addr)
      default: begin
        bridge_rd_data <= 0;
      end
      32'h2xxxxxxx: begin
        bridge_rd_data <= sd_read_data;
      end
      32'hFA000000: begin //Analogizer settings
        bridge_rd_data <= {18'h0,analogizer_settings};
      end
      32'hF8xxxxxx: begin
        bridge_rd_data <= cmd_bridge_rd_data;
      end
    endcase
  end
```

```
 always @(posedge clk_74a) begin
    if (reset_delay > 0) begin
      reset_delay <= reset_delay - 1;
    end

    if (bridge_wr) begin
      casex (bridge_addr)
        32'h0: begin
          ioctl_download <= bridge_wr_data[0];
        end
        32'h4: begin
          save_download <= bridge_wr_data[0];
        end
        ...
        /*[ANALOGIZER_HOOK_BEGIN]*/
		32'hFA000000: analogizer_settings  <=  bridge_wr_data[13:0];
	    /*[ANALOGIZER_HOOK_END]*/
        ...
      endcase
    end
  end
```


It may be necessary to synchronize the reading of the options, when using different clock domains:

```
  /*[ANALOGIZER_HOOK_BEGIN]*/
  //Pocket Menu settings
  reg [13:0] analogizer_settings = 0;
  wire [13:0] analogizer_settings_s;

  synch_3 #(.WIDTH(14)) sync_analogizer(analogizer_settings, analogizer_settings_s, clk_sys_42_95);

  always @(*) begin
    snac_game_cont_type   = analogizer_settings_s[4:0];
    snac_cont_assignment  = analogizer_settings_s[9:6];
    analogizer_video_type = analogizer_settings_s[13:10];
  end
  /*[ANALOGIZER_HOOK_END]*/
```


